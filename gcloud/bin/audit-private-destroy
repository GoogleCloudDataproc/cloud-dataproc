#!/bin/bash

# Script to audit resource cleanup after destroy-dpgce-private.sh
# Expected: No resources matching the patterns should be found.

source lib/env.sh
source lib/gcp/misc.sh # Source the file containing configure_gcloud

if (( DEBUG != 0 )); then
  set -x
fi

configure_gcloud # Set gcloud context

parse_args "$@" # Sets FORCE_AUDIT based on --force

if [[ -z "${CLUSTER_NAME}" || "${CLUSTER_NAME}" == "null" ]]; then
  echo "ERROR: CLUSTER_NAME is not set. Please source lib/env.sh after env.json is configured."
  exit 1
fi

LOG_DIR="tmp/destroy_audit_${CLUSTER_NAME}_$(date +%Y%m%d-%H%M%S)"
mkdir -p "${LOG_DIR}"
echo "Detailed logs will be saved in ${LOG_DIR}"

NOT_FOUND_LOGS=()

# --- Start Audit ---
echo "Starting resource cleanup audit for cluster: ${CLUSTER_NAME}"
if [[ "${FORCE_AUDIT}" == "true" ]]; then
  echo "--force flag detected, expecting ALL resources to be deleted."
fi

# 1. Dataproc Clusters
check_resource_exact "Dataproc Clusters" \
  "gcloud dataproc clusters list --region=\"${REGION}\" --project=\"${PROJECT_ID}\" --filter=\"clusterName = ${CLUSTER_NAME}\" --format=\"value(clusterName)\""

# 2. Service Accounts
check_resource_exact "Service Account" \
  "gcloud iam service-accounts list --project=\"${PROJECT_ID}\" --filter=\"email = ${GSA}\" --format=\"value(email)\""

# 3. Autoscaling Policies
check_resource "Autoscaling Policies" \
  "gcloud dataproc autoscaling-policies list --region=\"${REGION}\" --project=\"${PROJECT_ID}\" --format=\"value(id)\"" \
  "${AUTOSCALING_POLICY_NAME}"

# 4. Cloud Routers
check_resource "Cloud Routers" \
  "gcloud compute routers list --regions=\"${REGION}\" --project=\"${PROJECT_ID}\" --filter=\"network ~ ${NETWORK}$\" --format=\"value(name)\"" \
  "${ROUTER_NAME}"
check_resource "SWG Autogen Routers" \
  "gcloud compute routers list --regions=\"${REGION}\" --project=\"${PROJECT_ID}\" --filter=\"network ~ ${NETWORK}$\" --format=\"value(name)\"" \
  "swg-autogen-router-"

# 5. Firewall Rules
check_resource "Cluster Firewall Rules" \
  "gcloud compute firewall-rules list --project=\"${PROJECT_ID}\" --filter=\"network ~ ${NETWORK}$\" --format=\"value(name)\"" \
  "${CLUSTER_NAME}"
check_resource "SWP Ingress Firewall Rule" \
  "gcloud compute firewall-rules list --project=\"${PROJECT_ID}\" --filter=\"network ~ ${NETWORK}$\" --format=\"value(name)\"" \
  "allow-swp-ingress-${CLUSTER_NAME}"
check_resource "S8S Internal Firewall Rule" \
  "gcloud compute firewall-rules list --project=\"${PROJECT_ID}\" --filter=\"network ~ ${NETWORK}$\" --format=\"value(name)\"" \
  "allow-internal-s8s"

# 6. SWP Gateway
check_resource "SWP Gateway" \
  "gcloud network-services gateways list --location=\"${REGION}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
  "${SWP_INSTANCE_NAME}"

# 7. Gateway Security Policies
check_resource "Gateway Security Policies" \
  "gcloud network-security gateway-security-policies list --location=\"${REGION}\" --project=\"${PROJECT_ID}\" --filter=\"name ~ /${SWP_POLICY_NAME}$ \" --format=\"value(name)\"" \
  "${SWP_POLICY_NAME}"

# 8. Certificate Manager Certificate (Static)
check_resource "Static Cert Manager Certificate" \
  "gcloud certificate-manager certificates list --location=\"${REGION}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
  "${SWP_CERT_NAME}" \
  true # Optional

# 9. Certificate Issuance Configs (Optional without --force)
check_resource "Cert Issuance Configs" \
  "gcloud certificate-manager issuance-configs list --location=\"${REGION}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
  "swp-cic-${CLUSTER_NAME}-" \
  true # Optional

# 10. CA Pools (Optional without --force)
check_resource "CA Pools" \
  "gcloud privateca pools list --location=\"${REGION}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
  "swp-ca-pool-${CLUSTER_NAME}-" \
  true # Optional

# 11. Root CAs (Optional without --force)
ca_pool_prefix="swp-ca-pool-${CLUSTER_NAME}-"
pool_log="${LOG_DIR}/CA_Pools_for_Root_CA_check.log"
print_status "Checking: Root CAs in any lingering Pools... "
gcloud privateca pools list --location="${REGION}" --project="${PROJECT_ID}" --format="value(name)" > "${pool_log}" 2>&1
pool_names=$(grep "${ca_pool_prefix}" "${pool_log}" || true)
if [[ -n "${pool_names}" ]]; then
  if [[ "${FORCE_AUDIT}" == "false" ]]; then
    report_result "Kept"
    echo "  -> Found lingering CA Pools (expected without --force)."
  else
    report_result "Fail"
    echo "  -> Found lingering CA Pools, CAs might exist. Check logs in ${LOG_DIR}"
    while read -r pool_full_name; do
      short_pool_name=$(basename "${pool_full_name}")
      check_resource "Root CAs in ${short_pool_name}" \
        "gcloud privateca roots list --pool=\"${short_pool_name}\" --location=\"${REGION}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
        "swp-root-ca-${CLUSTER_NAME}-" \
        true # Optional
    done <<< "${pool_names}"
  fi
else
  report_result "Not Found"
fi

# 12. Subnets
check_resource "SWP Subnet" \
  "gcloud compute networks subnets list --network=\"${NETWORK}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
  "${SWP_SUBNET}"
check_resource "Private Subnet" \
  "gcloud compute networks subnets list --network=\"${NETWORK}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
  "${PRIVATE_SUBNET}"
check_resource "Main Subnet" \
  "gcloud compute networks subnets list --network=\"${NETWORK}\" --project=\"${PROJECT_ID}\" --format=\"value(name)\"" \
  "${SUBNET}"

# 13. VPC Network
check_resource_exact "VPC Network ${NETWORK}" "gcloud compute networks describe \"${NETWORK}\" --project=\"${PROJECT_ID}\""

# 14. GCS Buckets (Optional without --force)
check_resource_exact "GCS Staging Bucket gs://${BUCKET}" "gsutil ls -b 'gs://${BUCKET}'" true
check_resource_exact "GCS Temp Bucket gs://${TEMP_BUCKET}" "gsutil ls -b 'gs://${TEMP_BUCKET}'" true

echo -e "\nAudit complete."
echo -e "[${YELLOW}Pass*${NC}] indicates the resource was not found (which is expected after destroy)."
echo -e "[${BLUE}Kept${NC}] indicates the resource was found, which is expected as --force was not used."